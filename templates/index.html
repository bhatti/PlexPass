{% extends "authenticated_base.html" %}

{% block title %} Your Personal Password Manager {% endblock title %}

{% block header %}
<script>
    document.allCategories = [
        {% for category in all_categories %}
    '{{category}}',
    {% endfor %}
    ];
</script>
{% endblock header %}

{% block content %}
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-2 d-flex flex-column justify-content-between" id="vaultSidebar">
            <!-- Top Navigation Buttons -->
            <div class="text-left">
                <b><span class="fa fa-bars"></span>&nbsp;PlexPass Vaults</b>
                <nav class="sidenav">
                </nav>
                <ul class="nav nav-pills flex-column mb-auto">
                    {% for vault in vaults %}
                    {% if selected_vault.vault_id == vault.vault_id %}
                    <li class="nav-item">
                        <a href="?selected_vault_id={{vault.vault_id}}" class="nav-link active" aria-current="page">
                            <img width="32" height="32" src="{{vault.icon}}">&nbsp;{{vault.title}}</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a href="?selected_vault_id={{vault.vault_id}}" class="nav-link">
                            <img width="32" height="32" src="{{vault.icon}}">&nbsp;{{vault.title}}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="modal" onclick="showAddEditVault();" data-bs-target="#addVaultModal">
                            <span class="fa fa-plus"></span>&nbsp;Add New Vault
                        </button>
                    </li>
                </ul>

                <div class="sidebar-avatar">
                    <img src="/ui/avatar" alt="User Avatar">
                </div>

                <hr/>
                <nav class="sidenav theme-sidenav">
                    <a class="nav-link" aria-current="page" href="/ui/users/profile">[{{username}}]</a>
                    <a class="nav-link" href="/ui/signout"><span class="fa sign-out"></span>&nbsp;Signout</a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div id="top_tabs" class="col-10">
            <!-- Tabs -->
            <ul class="nav nav-tabs">
                <li class="nav-item" id="allTab">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault.vault_id}}&tab_name=all">All Accounts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault.vault_id}}&q=favorite&tab_name=favorite">Favorite Accounts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault.vault_id}}&q=high_risk&tab_name=high_risk">High-Risk Accounts</a>
                </li>
                {% for category in top_categories %}
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault.vault_id}}&q={{category}}&tab_name={{category}}">{{category}}</a>
                </li>
                {% endfor %}
            </ul>

            <!-- Filter accounts -->
            <div class="d-flex">
            </div>
            <div class="my-3 ms-auto">
                <button class="btn btn-outline-primary" data-toggle="modal" data-target="#editAccountModal"
                        onclick="addAccount('{{selected_vault.vault_id}}')">Add Account
                </button>
                <button class="btn btn-outline-secondary" data-toggle="modal" data-target="#importAccountsModal"
                        onclick="importAccounts('{{selected_vault.vault_id}}')">Import Accounts</button>
                <button class="btn btn-outline-success" data-toggle="modal" data-target="#importAccountsModal"
                        onclick="exportAccounts('{{selected_vault.vault_id}}')">Export Accounts</button>
                <button class="btn btn-outline-warning" data-toggle="modal" data-target="#shareVaultModal"
                        onclick="shareVault('{{selected_vault.vault_id}}')">Share Vault</button>
                <button class="btn btn-outline-warning" data-toggle="modal" data-target="#shareVaultModal"
                        onclick="unshareVault('{{selected_vault.vault_id}}')">UnShare Vault</button>
                <button class="btn btn-outline-info" data-toggle="modal" data-target="#shareVaultModal"
                        onclick="showAddEditVault('{{selected_vault.vault_id}}', {{selected_vault.version}}, '{{selected_vault.title}}', '{{selected_vault.kind}}');">Edit Vault</button>
                <button class="btn btn-outline-danger" data-toggle="modal" data-target="#shareVaultModal"
                        onclick="deleteVault('{{selected_vault.vault_id}}', '{{selected_vault.title}}');">Delete Vault</button>
                <form action="/">
                    <input type="hidden" name="selected_vault_id" value="{{selected_vault.vault_id}}">
                    <div class="d-flex form-group mb-5">
                        <input class="form-control me-2" type="search" name="q" value="{{q}}" placeholder="Filter..."
                               aria-label="Filter">
                        <button class="btn btn-outline-success" type="submit">Filter</button>
                    </div>
                </form>
            </div>

            <!-- Table -->
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Label</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Category & Tags</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                {% for account in accounts %}
                <tr>
                    <td>
                        {% if account.has_favicon() %}
                        <img width="16" height="16" src="{{account.favicon()}}">
                        &nbsp;
                        {% endif %}
                        {% if account.has_url() %}
                        <a href="{{account.website_url()}}">{{account.label_description()}}</a>
                        {% else %}
                        {{account.label_description()}}
                        {% endif %}
                        {% if account.has_risk_image() %}
                        <img width="32" height="32" src="{{account.risk_image()}}">
                        {% endif %}
                    </td>
                    <td>{{account.username()}}</td>
                    <td>{{account.email()}}</td>
                    <td>{{account.all_cat_tags()}}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#viewAccountModal"
                                onclick="viewAccount('{{account.account_id}}')">View
                        </button>
                        <button class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#editAccountModal"
                                onclick="editAccount('{{account.account_id}}')">Edit
                        </button>
                        <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deletetModal"
                                onclick="deleteAccount('{{account.account_id}}')">Delete
                        </button>
                        <button class="btn btn-warning btn-sm" data-toggle="modal" data-target="#shareAccountModal"
                                onclick="shareAccount('{{account.account_id}}')">Share
                        </button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
{% endblock content %}

{% block extra_content %}
<!-- View Modal -->
<div class="modal fade theme-modal" id="viewAccountModal" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="viewModalLabel">View Account</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Details Here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade theme-modal" id="editAccountModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="editAccountTitle">Edit Account</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <form id="accountEditForm" name="accountEditForm"
                  onsubmit="event.preventDefault(); handleSaveAccount(this);"
                  method="POST">
                <div class="modal-body">
                    <!-- Edit Fields Here -->
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade theme-modal" id="importAccountsModal" tabindex="-1" aria-labelledby="importAccountsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importAccountsModalLabel">Import CSV File of Accounts</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-3" type="file" id="fileImport">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="mb-3">
                    <label for="importPasswordInput">Password for Encryption (Optional):</label>
                    <input type="password" class="form-control" id="importPasswordInput" name="password" placeholder="Enter password">
                    <small class="form-text text-muted">This password will be used to decrypt your data.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="importButton" onclick="handleImportAccounts('{{selected_vault.vault_id}}');">Upload CSV</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade theme-modal" id="exportAccountsModal" tabindex="-1" aria-labelledby="exportAccountsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportAccountsModalLabel">Export Vault Accounts</h5>
                <button type="button" class="close" data-bs-dismiss="modal" onclick="hideExportAccounts();">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportPasswordInput">Password for Encryption (Optional):</label>
                    <input type="password" class="form-control" id="exportPasswordInput" name="password" placeholder="Enter password">
                    <small class="form-text text-muted">This password will be used to encrypt your data.</small>
                </div>
                <div class="mb-3">
                    <label for="exportProgress" class="form-label">Progress</label>
                    <div class="progress">
                        <div class="progress-bar" id="exportProgress" role="progressbar"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="hideExportAccounts();">Close</button>
                <button type="button" class="btn btn-primary" id="exportButton" onclick="handleExportAccounts('{{selected_vault.vault_id}}');">Export Accounts</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Vault Modal -->
<div class="modal fade theme-modal" id="shareVaultModal" tabindex="-1" aria-labelledby="shareVaultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareVaultModalLabel">Share Vault</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareVaultUserInput">Username:</label>
                    <div class="autocomplete theme-container">
                        <input type="text" class="form-control" id="shareVaultUserInput" name="username" placeholder="Enter username to share with">
                    </div>
                    <small id="shareVaultUserMessage" class="form-text text-muted">Type in username who will be able to access all accounts in this vault.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="shareVaultButton" onclick="handleShareUnShareVault('{{selected_vault.vault_id}}');">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Account Modal -->
<div class="modal fade theme-modal" id="shareAccountModal" tabindex="-1" aria-labelledby="shareAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareAccountModalLabel">Share Account</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareAccountUserInput">Username:</label>
                    <input type="hidden" id="shareAccountId">
                    <div class="autocomplete theme-container">
                        <input type="text" class="form-control" id="shareAccountUserInput" name="username" placeholder="Enter username to share with">
                    </div>
                    <small class="form-text text-muted">Type in username who will be able to access this account.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="shareAccountButton" onclick="handleShareAccount('{{selected_vault.vault_id}}');">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade theme-modal" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAccountModalLabel">Delete Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this account?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Vault Modal -->
<div class="modal fade" id="vaultModal" tabindex="-1" aria-labelledby="vaultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content theme-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="vaultModalLabel">Vault Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="vaultForm">
                    <input type="hidden" name="vault_id" class="form-control" id="vaultId" required>
                    <input type="hidden" name="vault_version" class="form-control" id="vaultVersion">
                    <div class="mb-3">
                        <label for="vaultName" class="form-label">Vault Name</label>
                        <input type="text" name="title" class="form-control" id="vaultName" placeholder="Enter Vault title" required>
                    </div>
                    <div class="mb-3">
                        <label for="vaultKind" class="form-label">Vault Kind</label>
                        <select class="form-select" id="vaultKind" name="kind">
                            <option value="Logins">Logins</option>
                            <option value="SecureNotes">Secure Notes</option>
                            <option value="FormData">Form/Custom Data</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vaultIcon" class="form-label">Vault Icon (Optional)</label>
                        <input type="file" class="form-control" id="vaultIcon" name="icon">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveVaultButton" onclick="saveVaultDetails()">Save Changes</button>
            </div>
        </div>
    </div>
</div>


{% endblock extra_content %}

{% block footer %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initEventHandlers();
    }, false);

    document.addEventListener('DOMContentLoaded', (_event) => {
        const urlParams = new URLSearchParams(window.location.search);
        const activeQueryParam = urlParams.get('tab_name') || '';

        // Remove 'active' class from all tabs within 'top_tabs' div
        document.querySelectorAll('#top_tabs .nav-link').forEach(link => {
            link.classList.remove('active');
        });

        // Add 'active' class to the tab within 'top_tabs' div that matches the 'q' parameter
        let activeTabFound = false;
        document.querySelectorAll('#top_tabs .nav-item .nav-link').forEach(link => {
            if (!activeTabFound && link.href.includes(`tab_name=${activeQueryParam}`)) {
                link.classList.add('active');
                activeTabFound = true;
            }
        });
        if (!activeTabFound) {
            const firstTab = document.querySelector('#top_tabs .nav-item .nav-link');
            if (firstTab) {
                firstTab.classList.add('active');
            }
        }
    });
</script>
{% endblock footer %}
