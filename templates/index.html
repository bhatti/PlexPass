{% extends "base.html" %}

{% block title %} Your Personal Password Manager {% endblock title %}

{% block header %}
<script>
    document.allCategories = [
        {% for category in all_categories %}
    '{{category}}',
    {% endfor %}
    ];
</script>
{% endblock header %}

{% block content %}
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-2 bg-light d-flex flex-column justify-content-between">
            <!-- Top Navigation Buttons -->
            <div class="text-center">
                <b><span class="fa fa-bars"></span>&nbsp;PlexPass Vaults</b>
                <nav class="sidenav">
                </nav>

                <div id="sidebar" class="flex-column flex-shrink-0 p-3">
                    <ul class="nav nav-pills flex-column mb-auto">
                        {% for vault in vaults %}
                        {% if selected_vault_id == vault.vault_id %}
                        <li class="nav-item">
                            <a href="?selected_vault_id={{vault.vault_id}}" class="nav-link active" aria-current="page">{{vault.title}}</a>
                        </li>
                        {% else %}
                        <li class="nav-item">
                            <a href="?selected_vault_id={{vault.vault_id}}" class="nav-link">{{vault.title}}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        </li>
                    </ul>
                </div>
                <hr/>
                <nav class="sidenav">
                    <a class="nav-link active" aria-current="page" href="#">[{{username}}]</a>
                    <a class="nav-link" href="/ui/signout"><span class="fa sign-out"></span>&nbsp;Signout</a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-10">
            <!-- Tabs -->
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="?selected_vault_id={{selected_vault_id}}">All Accounts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault_id}}&q=favorite">Favorite Accounts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault_id}}&q=high_risk">High-Risk Accounts</a>
                </li>
                {% for category in top_categories %}
                <li class="nav-item">
                    <a class="nav-link" href="?selected_vault_id={{selected_vault_id}}&q={{category}}">{{category}}</a>
                </li>
                {% endfor %}
            </ul>

            <!-- Filter accounts -->
            <div class="d-flex">
            </div>
            <div class="my-3 ms-auto">
                <button class="btn btn-primary" data-toggle="modal" data-target="#editAccountModal"
                        onclick="addAccount('{{selected_vault_id}}')">Add Account
                </button>
                <button class="btn btn-secondary" data-toggle="modal" data-target="#importAccountsModal"
                        onclick="importAccounts('{{selected_vault_id}}')">Import Accounts</button>
                <button class="btn btn-dark" data-toggle="modal" data-target="#importAccountsModal"
                        onclick="exportAccounts('{{selected_vault_id}}')">Export Accounts</button>
                <button class="btn btn-warning" data-toggle="modal" data-target="#shareVaultModal"
                        onclick="shareVault('{{selected_vault_id}}')">Share Vault</button>
                <form action="/">
                    <input type="hidden" name="selected_vault_id" value="{{selected_vault_id}}">
                    <div class="d-flex form-group mb-5">
                        <input class="form-control me-2" type="search" name="q" placeholder="Filter..."
                               aria-label="Filter">
                        <button class="btn btn-outline-success" type="submit">Filter</button>
                    </div>
                </form>
            </div>

            <!-- Table -->
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Label</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Category & Tags</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                {% for account in accounts %}
                <tr>
                    <td style="{{account.risk_bg_color()}}">
                        {% if account.has_favicon() %}
                        <img width="16" height="16" src="{{account.favicon()}}">
                        {% endif %}
                        {% if account.has_url() %}
                        <a href="{{account.url()}}">{{account.label_description()}}</a>
                        {% else %}
                        {{account.label_description()}}
                        {% endif %}
                    </td>
                    <td>{{account.username()}}</td>
                    <td>{{account.email()}}</td>
                    <td>{{account.all_cat_tags()}}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#viewAccountModal"
                                onclick="viewAccount('{{account.account_id}}')">View
                        </button>
                        <button class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#editAccountModal"
                                onclick="editAccount('{{account.account_id}}')">Edit
                        </button>
                        <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deletetModal"
                                onclick="deleteAccount('{{account.account_id}}')">Delete
                        </button>
                        <button class="btn btn-warning btn-sm" data-toggle="modal" data-target="#deletetModal"
                                onclick="shareAccount('{{account.account_id}}')">Share
                        </button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
{% endblock content %}

{% block extra_content %}
<!-- View Modal -->
<div class="modal fade" id="viewAccountModal" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="viewModalLabel">View Account</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Details Here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editAccountModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="editAccountTitle">Edit Account</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <form id="accountEditForm" name="accountEditForm"
                  onsubmit="event.preventDefault(); handleSaveAccount(this);"
                  method="POST">
                <div class="modal-body">
                    <!-- Edit Fields Here -->
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importAccountsModal" tabindex="-1" aria-labelledby="importAccountsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importAccountsModalLabel">Import CSV File of Accounts</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-3" type="file" id="fileImport">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="mb-3">
                    <label for="importPasswordInput">Password for Encryption (Optional):</label>
                    <input type="password" class="form-control" id="importPasswordInput" name="password" placeholder="Enter password">
                    <small class="form-text text-muted">This password will be used to decrypt your data.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="importButton" onclick="handleImportAccounts('{{selected_vault_id}}');">Upload CSV</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportAccountsModal" tabindex="-1" aria-labelledby="exportAccountsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportAccountsModalLabel">Export Vault Accounts</h5>
                <button type="button" class="close" data-bs-dismiss="modal" onclick="hideExportAccounts();">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportPasswordInput">Password for Encryption (Optional):</label>
                    <input type="password" class="form-control" id="exportPasswordInput" name="password" placeholder="Enter password">
                    <small class="form-text text-muted">This password will be used to encrypt your data.</small>
                </div>
                <div class="mb-3">
                    <label for="exportProgress" class="form-label">Progress</label>
                    <div class="progress">
                        <div class="progress-bar" id="exportProgress" role="progressbar"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="hideExportAccounts();">Close</button>
                <button type="button" class="btn btn-primary" id="exportButton" onclick="handleExportAccounts('{{selected_vault_id}}');">Export Accounts</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Vault Modal -->
<div class="modal fade" id="shareVaultModal" tabindex="-1" aria-labelledby="shareVaultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareVaultModalLabel">Share Vault</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareVaultUserInput">Username:</label>
                    <div class="autocomplete">
                        <input type="text" class="form-control" id="shareVaultUserInput" name="username" placeholder="Enter username to share with">
                    </div>
                    <small class="form-text text-muted">Type in username who will be able to access all accounts in this vault.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="shareVaultButton" onclick="handleShareVault('{{selected_vault_id}}');">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Account Modal -->
<div class="modal fade" id="shareAccountModal" tabindex="-1" aria-labelledby="shareAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareAccountModalLabel">Share Account</h5>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareAccountUserInput">Username:</label>
                    <input type="hidden" id="shareAccountId">
                    <div class="autocomplete">
                        <input type="text" class="form-control" id="shareAccountUserInput" name="username" placeholder="Enter username to share with">
                    </div>
                    <small class="form-text text-muted">Type in username who will be able to access this account.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="shareAccountButton" onclick="handleShareAccount('{{selected_vault_id}}');">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAccountModalLabel">Delete Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this account?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock extra_content %}

{% block footer %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initEventHandlers();
    }, false);
</script>
{% endblock footer %}
